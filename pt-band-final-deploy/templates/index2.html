<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-4">
  <!-- í—¤ë”: ì œëª©, ê¸€ ì¶”ê°€ ë²„íŠ¼, êµ¬ì¸/êµ¬ì§ í•„í„°, ì§€ì—­ í•„í„° -->
  <div class="flex justify-between items-center mb-4 border-b pb-2">
    <h1 class="text-2xl md:text-3xl font-bold text-black whitespace-nowrap">
      ğŸ“Œ í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§ ê²Œì‹œíŒ
      <span class="text-sm text-gray-500 ml-1">( ì „ì²´ / ì „ì²´ )</span>
    </h1>
    <div class="flex items-center space-x-2">
      <button onclick="App.openForm()" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 text-sm rounded">+</button>
      <select id="typeFilter" class="border p-1 text-sm">
        <option value="ì „ì²´" selected>ì „ì²´</option>
        <option value="êµ¬ì¸">êµ¬ì¸</option>
        <option value="êµ¬ì§">êµ¬ì§</option>
      </select>
      <select id="regionFilter" class="border p-1 text-sm">
        <option value="ê²½ê¸°ë„ > í‰íƒì‹œ" selected>ê²½ê¸°ë„ > í‰íƒì‹œ</option>
        <option value="ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ">ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ</option>
        <option value="ê²½ê¸°ë„ > í™”ì„±ì‹œ">ê²½ê¸°ë„ > í™”ì„±ì‹œ</option>
        <option value="ê²½ê¸°ë„ > ì•ˆì„±ì‹œ">ê²½ê¸°ë„ > ì•ˆì„±ì‹œ</option>
        <option value="ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬">ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬</option>
        <option value="ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬">ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬</option>
        <option value="ì „ì²´">ì „ì²´</option>
      </select>
    </div>
  </div>

  <!-- íŒŒíŠ¸ í•„í„°ë§ ì²´í¬ë°•ìŠ¤ -->
  <div id="partFilterContainer" class="mb-4">
    <span class="text-sm font-semibold mr-2">íŒŒíŠ¸ í•„í„°:</span>
    <label><input type="checkbox" class="part-filter" value="ì „ì²´" checked /> ì „ì²´</label>
    <label><input type="checkbox" class="part-filter" value="ë³´ì»¬" checked /> ë³´ì»¬</label>
    <label><input type="checkbox" class="part-filter" value="ë“œëŸ¼" checked /> ë“œëŸ¼</label>
    <label><input type="checkbox" class="part-filter" value="ë² ì´ìŠ¤" checked /> ë² ì´ìŠ¤</label>
    <label><input type="checkbox" class="part-filter" value="ê¸°íƒ€" checked /> ê¸°íƒ€</label>
    <label><input type="checkbox" class="part-filter" value="í‚¤ë³´ë“œ" checked /> í‚¤ë³´ë“œ</label>
    <label><input type="checkbox" class="part-filter" value="ê·¸ ì™¸" checked /> ê·¸ ì™¸</label>
  </div>

  <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
  {% set part_emojis = {
    'ë³´ì»¬(ë‚¨)': 'ğŸ¤',
    'ë³´ì»¬(ì—¬)': 'ğŸ¤',
    'ë“œëŸ¼': 'ğŸ¥',
    'ë² ì´ìŠ¤': 'ğŸ¸',
    'ê¸°íƒ€': 'ğŸ¸',
    'í‚¤ë³´ë“œ': 'ğŸ¹',
    'ê·¸ ì™¸': 'ğŸ”¸'
  } %}
  {% for job in jobs %}
  <div class="bg-white p-4 mb-6 rounded shadow-lg relative job-item {% if job.pinned %} border-4 border-red-500 {% endif %}" 
       data-type="{{ job.type }}" 
       data-part="{{ job.part|join(',') }}" 
       data-region="{{ job.region or 'ê²½ê¸°ë„ > í‰íƒì‹œ' }}">
    <div class="absolute top-2 right-3 flex gap-1">
      <button class="text-xs text-gray-600 hover:underline" onclick="App.openMatchPopup({{ loop.index0 }})">ë§¤ì¹­ìƒíƒœ ë³€ê²½</button>
    </div>
    <h2 class="text-xl font-semibold mb-1">
      {% if job.type == 'êµ¬ì§' %}
        [ {% for part in job.part %}{{ part_emojis.get(part, '') }}{{ part }}{% if not loop.last %} / {% endif %}{% endfor %} ]
      {% else %}
        [{{ job.team or 'íŒ€ëª… ë¯¸ì •' }}]
      {% endif %}
      <span class="text-sm text-gray-500 ml-1">
        ({{ job.region or 'ê²½ê¸°ë„ > í‰íƒì‹œ' }} / 
        {% if job.type == 'êµ¬ì¸' %}
          ëª¨ì§‘í•©ë‹ˆë‹¤!
        {% else %}
          ë°ë ¤ê°€ì„¸ìš”!
        {% endif %}
        )
      </span>
    </h2>
    <p class="text-sm text-gray-600 mb-2">
      {% if job.type == 'êµ¬ì¸' %}
        <strong>
          {% for part in job.part %}
            {{ part_emojis.get(part, '') }}{{ part }}{% if not loop.last %} / {% endif %}
          {% endfor %}
        </strong>
        ë©¤ë²„ê°€ í•„ìš”í•´ìš”!
      {% else %}
        <strong>
          {% for part in job.part %}
            {{ part_emojis.get(part, '') }}{{ part }}{% if not loop.last %} / {% endif %}
          {% endfor %}
        </strong>
        {{ job.intro }}
      {% endif %}
    </p>
    <!-- íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ -->
    <p class="text-xs text-gray-600">
      {% if job.updated_at %}
        {{ job.updated_at | datetimeformat }} ìˆ˜ì •
      {% else %}
        {{ job.created_at | datetimeformat }} ë“±ë¡
      {% endif %}
    </p>
    <div class="flex justify-between items-center mt-2">
      <span class="text-xs text-blue-500 cursor-pointer ml-1" onclick="App.toggleExpand(this)">&lt;ë” ë³´ê¸°&gt;</span>
      <a href="tel:{{ job.contact }}" onclick="fetch('/click/{{ loop.index0 }}', { method: 'POST' })" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ë§¤ì¹­í•˜ê¸°</a>
    </div>
    <div class="mt-1">
      <p class="text-xs text-gray-600">ğŸ‘ {{ job.clicks or 0 }}ëª…ì´ ì—°ë½ì²˜ë¥¼ í™•ì¸í–ˆì–´ìš”.</p>
    </div>
  </div>
  {% endfor %}

  <!-- ëª¨ë“ˆí™”ëœ í•¨ìˆ˜ë“¤ -->
  <script>
    (function(){
      const App = {
        getPartChecklist: function() {
          const group1 = ["ë³´ì»¬(ë‚¨)", "ë³´ì»¬(ì—¬)", "ë“œëŸ¼", "ë² ì´ìŠ¤"];
          const group2 = ["ê¸°íƒ€", "í‚¤ë³´ë“œ", "ê·¸ ì™¸"];
          const group1HTML = group1.map(part => `<label class='mr-2'><input type='checkbox' name='part' value='${part}' class='mr-1' />${part}</label>`).join(' ');
          const group2HTML = group2.map(part => `<label class='mr-2'><input type='checkbox' name='part' value='${part}' class='mr-1' />${part}</label>`).join(' ');
          return group1HTML + "<br>" + group2HTML;
        },
        filterByParts: function() {
          const checkboxes = document.querySelectorAll('.part-filter');
          let selected = [];
          checkboxes.forEach(chk => {
            if (chk.checked && chk.value !== "ì „ì²´") {
              selected.push(chk.value);
            }
          });
          const isAll = document.querySelector('.part-filter[value="ì „ì²´"]').checked;
          const jobItems = document.querySelectorAll('.job-item');
          jobItems.forEach(item => {
            if (isAll) {
              item.style.display = "";
            } else {
              const parts = item.dataset.part;
              let match = false;
              for (let filter of selected) {
                if (filter === "ë³´ì»¬") {
                  if (parts.includes("ë³´ì»¬(ë‚¨)") || parts.includes("ë³´ì»¬(ì—¬)")) {
                    match = true;
                    break;
                  }
                } else if (parts.includes(filter)) {
                  match = true;
                  break;
                }
              }
              item.style.display = match ? "" : "none";
            }
          });
        },
        filterByRegion: function() {
          const regionSelect = document.getElementById('regionFilter');
          const selectedRegion = regionSelect.value;
          const jobItems = document.querySelectorAll('.job-item');
          jobItems.forEach(item => {
            const itemRegion = item.getAttribute('data-region');
            if (selectedRegion === "ì „ì²´" || itemRegion === selectedRegion) {
              // ë§Œì•½ ì´ë¯¸ ë‹¤ë¥¸ í•„í„°ì— ì˜í•´ ìˆ¨ê²¨ì§„ ê²½ìš°ëŠ” ë‹¤ë¥¸ í•„í„°ì™€ í•¨ê»˜ ê³ ë ¤í•´ì•¼ í•¨
              // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ì§€ì—­ë§Œ ë¹„êµí•©ë‹ˆë‹¤.
              item.style.display = "";
            } else {
              item.style.display = "none";
            }
          });
        },
        filterJobs: function() {
          const typeSelect = document.getElementById('typeFilter');
          const selectedType = typeSelect ? typeSelect.value : 'ì „ì²´';
          const jobItems = document.querySelectorAll('.job-item');
          jobItems.forEach(el => {
            const jobType = el.getAttribute('data-type');
            if (selectedType === "ì „ì²´" || jobType === selectedType) {
              el.style.display = "";
            } else {
              el.style.display = "none";
            }
          });
          App.filterByParts();
          App.filterByRegion();
        },
        openForm: function() {
          const popup = document.createElement('div');
          popup.className = 'fixed top-1/2 left-1/2 bg-white p-4 rounded shadow z-50 max-w-sm w-full';
          popup.style.transform = 'translate(-50%, -50%)';
          popup.innerHTML = `
            <div class='text-right'><button onclick='this.parentElement.parentElement.remove()' class='text-sm text-red-500'>âœ– ë‹«ê¸°</button></div>
            <form id='new-post-form'>
              <p class='mb-2 text-sm font-semibold'>ê¸€ ì‘ì„±í•˜ê¸°</p>
              <div class='mb-2'>
                <label class='block text-sm font-medium mb-1'>êµ¬ë¶„:</label>
                <select name='type' class='border p-1 w-full'>
                  <option value='êµ¬ì¸'>êµ¬ì¸</option>
                  <option value='êµ¬ì§'>êµ¬ì§</option>
                </select>
              </div>
              <div id='form-content'></div>
              <div class='mt-4 text-right'>
                <button type='submit' class='bg-blue-600 text-white px-3 py-1 rounded'>ë“±ë¡</button>
              </div>
            </form>`;
          document.body.appendChild(popup);
      
          const formTypeSelect = popup.querySelector('select[name="type"]');
          const formContent = popup.querySelector('#form-content');
          formTypeSelect.onchange = () => App.renderFormFields(formContent, formTypeSelect.value);
          App.renderFormFields(formContent, 'êµ¬ì¸');
      
          document.getElementById('new-post-form').onsubmit = (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const type = form.get('type');
            const payload = {
              type,
              team: form.get('team') || '',
              nickname: form.get('nickname') || '',
              age: form.get('age') || '',
              region: form.get('region') || 'ê²½ê¸°ë„ > í‰íƒì‹œ',
              location: form.get('location') || '',
              fee: form.get('fee') || '',
              contact: form.get('contact') || '',
              intro: form.get('intro') || '',
              password: form.get('password'),
              part: [...form.getAll('part')]
            };
            fetch('/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }).then(res => res.json()).then(result => {
              if (result.success) location.reload();
              else alert('ë“±ë¡ ì‹¤íŒ¨: ' + (result.message || 'ì˜¤ë¥˜'));
            });
          }
        },
        getPartChecklist: function() {
          const group1 = ["ë³´ì»¬(ë‚¨)", "ë³´ì»¬(ì—¬)", "ë“œëŸ¼", "ë² ì´ìŠ¤"];
          const group2 = ["ê¸°íƒ€", "í‚¤ë³´ë“œ", "ê·¸ ì™¸"];
          const group1HTML = group1.map(part => `<label class='mr-2'><input type='checkbox' name='part' value='${part}' class='mr-1' />${part}</label>`).join(' ');
          const group2HTML = group2.map(part => `<label class='mr-2'><input type='checkbox' name='part' value='${part}' class='mr-1' />${part}</label>`).join(' ');
          return group1HTML + "<br>" + group2HTML;
        },
        renderFormFields: function(container, type) {
          const checklistHTML = App.getPartChecklist();
          const regionSelectHTML = `
            <select required name="region" class="border p-1 w-full mb-2">
              <option value="ê²½ê¸°ë„ > í‰íƒì‹œ" selected>ê²½ê¸°ë„ > í‰íƒì‹œ</option>
              <option value="ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ">ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ</option>
              <option value="ê²½ê¸°ë„ > í™”ì„±ì‹œ">ê²½ê¸°ë„ > í™”ì„±ì‹œ</option>
              <option value="ê²½ê¸°ë„ > ì•ˆì„±ì‹œ">ê²½ê¸°ë„ > ì•ˆì„±ì‹œ</option>
              <option value="ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬">ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬</option>
              <option value="ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬">ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬</option>
            </select>
          `;
          if (type === 'êµ¬ì¸') {
            container.innerHTML = `
              <input required name='team' placeholder='ë°´ë“œëª… í•„ìˆ˜' class='border p-1 w-full mb-2' />
              <input required name='nickname' placeholder='ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„ í•„ìˆ˜' class='border p-1 w-full mb-2' />
              <input name='age' placeholder='ë©¤ë²„ ì—°ë ¹ëŒ€' class='border p-1 w-full mb-2' />
              <div class='mb-2'><label class='block mb-1'>êµ¬ì¸ íŒŒíŠ¸:</label>${checklistHTML}</div>
              <input required name='location' placeholder='ì—°ìŠµì‹¤ ìœ„ì¹˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
              ${regionSelectHTML}
              <input name='fee' placeholder='ì›” íšŒë¹„ ì„ íƒ' class='border p-1 w-full mb-2' />
              <input required name='contact' placeholder='ì—°ë½ì²˜ í•„ìˆ˜' class='border p-1 w-full mb-2' />
              <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2' oninput="App.updateCharCount(this)"></textarea>
              <div class='text-right text-xs text-gray-500' id='char-count'>(0/100 byte)</div>
              <input required name='password' type='password' maxlength="4" placeholder='ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬' class='border p-1 w-full mb-2' />
            `;
          } else {
            container.innerHTML = `
              <input required name='nickname' placeholder='ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
              <div class='mb-2'><label class='block mb-1'>êµ¬ì§ íŒŒíŠ¸:</label>${checklistHTML}</div>
              <input required name='location' placeholder='ì„ í˜¸ ì—°ìŠµì‹¤ ìœ„ì¹˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
              ${regionSelectHTML}
              <input name='age' placeholder='ë©¤ë²„ ì—°ë ¹ëŒ€' class='border p-1 w-full mb-2' />
              <input required name='contact' placeholder='ì—°ë½ì²˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
              <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2'></textarea>
              <input required name='password' type='password' maxlength="4" placeholder='ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)' class='border p-1 w-full mb-2' />
            `;
          }
        },
        openMatchPopup: function(index) {
          const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          if (!pw) return;
          fetch(`/verify-password/${index}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
          })
          .then(res => res.json())
          .then(data => {
            if (!data.success) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            const job = data.job;
            const parts = job.part || [];
            const partOptions = parts.map(part => `<label><input type='checkbox' name='match' value='${part}'> ${part}</label>`).join('<br>');
            const html = `<div class='text-right mb-2'><button onclick='this.parentElement.parentElement.remove()' class='text-sm text-red-500'>âœ– ë‹«ê¸°</button></div>
            <form id='match-form'>
              <p class='mb-2 text-sm font-semibold'>ê¸€ ìˆ˜ì • ë° ë§¤ì¹­ì™„ë£Œ ì„¤ì •</p>
              <input type='text' name='team' value='${job.team}' placeholder='íŒ€ëª…' class='border p-1 w-full mb-2' />
              <input type='text' name='location' value='${job.location}' placeholder='ìœ„ì¹˜' class='border p-1 w-full mb-2' />
              <input type='text' name='type' value='${job.type}' placeholder='êµ¬ë¶„ êµ¬ì¸/êµ¬ì§' class='border p-1 w-full mb-2' />
              <input type='text' name='age' value='${job.age}' placeholder='ì—°ë ¹ëŒ€' class='border p-1 w-full mb-2' />
              <select required name="region" class="border p-1 w-full mb-2">
                <option value="ê²½ê¸°ë„ > í‰íƒì‹œ" ${job.region === "ê²½ê¸°ë„ > í‰íƒì‹œ" || !job.region ? 'selected' : ''}>ê²½ê¸°ë„ > í‰íƒì‹œ</option>
                <option value="ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ" ${job.region === "ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ" ? 'selected' : ''}>ê²½ê¸°ë„ > ì˜¤ì‚°ì‹œ</option>
                <option value="ê²½ê¸°ë„ > í™”ì„±ì‹œ" ${job.region === "ê²½ê¸°ë„ > í™”ì„±ì‹œ" ? 'selected' : ''}>ê²½ê¸°ë„ > í™”ì„±ì‹œ</option>
                <option value="ê²½ê¸°ë„ > ì•ˆì„±ì‹œ" ${job.region === "ê²½ê¸°ë„ > ì•ˆì„±ì‹œ" ? 'selected' : ''}>ê²½ê¸°ë„ > ì•ˆì„±ì‹œ</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬" ${job.region === "ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬" ? 'selected' : ''}>ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬</option>
                <option value="ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬" ${job.region === "ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬" ? 'selected' : ''}>ë¶€ì‚°ê´‘ì—­ì‹œ > í•´ìš´ëŒ€êµ¬</option>
              </select>
              <label class='block mb-2'><input type='checkbox' name='pinned' value='true' ${ job.pinned ? "checked" : "" } /> ìƒë‹¨ ê³ ì •</label>
              <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2 my-2' oninput='App.updateCharCount(this)'>\${job.intro}</textarea>
              <div class='text-right text-xs text-gray-500' id='char-count'>(\${new Blob([job.intro || '']).size}/100 byte)</div>
              <p class='mb-1 text-sm'>âœ… ë§¤ì¹­ ì™„ë£Œí•  íŒŒíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
              ${partOptions}
              <div class='mt-3'>
                <button type='submit' class='bg-green-600 text-white px-3 py-1 rounded'>ì €ì¥</button>
              </div>
            </form>`;
            const popup = document.createElement('div');
            popup.className = 'fixed top-1/2 left-1/2 bg-white p-4 rounded shadow z-50 max-w-sm w-full';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.innerHTML = html;
            document.body.appendChild(popup);
      
            const matchedPartsDiv = document.createElement('div');
            matchedPartsDiv.classList.add('mt-4');
            matchedPartsDiv.innerHTML = `
              <h3 class='text-sm font-semibold text-gray-600'>ë§¤ì¹­ ì™„ë£Œëœ íŒŒíŠ¸:</h3>
              <ul class='list-disc pl-5'>
                ${Object.entries(job.matched_parts).map(([part, _]) => `<li class='text-gray-600'>${job.team} - ${{
                  'ë³´ì»¬(ë‚¨)': 'ğŸ¤',
                  'ë³´ì»¬(ì—¬)': 'ğŸ¤',
                  'ë“œëŸ¼': 'ğŸ¥',
                  'ë² ì´ìŠ¤': 'ğŸ¸',
                  'ê¸°íƒ€': 'ğŸ¸',
                  'í‚¤ë³´ë“œ': 'ğŸ¹',
                  'ê·¸ ì™¸': 'ğŸ”¸'
                }[part] || ''} ${part}</li>`).join('')}
              </ul>
            `;
            popup.appendChild(matchedPartsDiv);
      
            document.getElementById('match-form').onsubmit = (e) => {
              e.preventDefault();
              const form = new FormData(e.target);
              const updated = {
                team: form.get('team'),
                location: form.get('location'),
                type: form.get('type'),
                age: form.get('age') || '',
                region: form.get('region') || 'ê²½ê¸°ë„ > í‰íƒì‹œ',
                intro: form.get('intro'),
                password: pw,
                parts: [...e.target.querySelectorAll('input[name="match"]:checked')].map(i => i.value)
              };
              fetch(`/update/${index}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updated)
              }).then(res => res.json()).then(resp => {
                if (resp.success) location.reload();
                else alert("ì €ì¥ ì‹¤íŒ¨: " + (resp.message || "ì˜¤ë¥˜"));
              });
            };
          });
        },
        toggleExpand: function(el) {
          const container = el.closest('.job-item');
          const content = container.querySelector('.expand-content');
          const toggleBtn = el;
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            toggleBtn.innerHTML = '&lt;ì ‘ê¸°&gt;';
          } else {
            content.classList.add('hidden');
            toggleBtn.innerHTML = '&lt;ë” ë³´ê¸°&gt;';
          }
        },
        updateCharCount: function(textarea) {
          const countDisplay = document.getElementById('char-count');
          if (!countDisplay) return;
          const length = new Blob([textarea.value]).size;
          countDisplay.textContent = `(${length}/100 byte)`;
        },
        filterByRegion: function() {
          const regionSelect = document.getElementById('regionFilter');
          const selectedRegion = regionSelect.value;
          const jobItems = document.querySelectorAll('.job-item');
          jobItems.forEach(item => {
            const itemRegion = item.getAttribute('data-region');
            if (selectedRegion === "ì „ì²´" || itemRegion === selectedRegion) {
              item.style.display = "";
            } else {
              item.style.display = "none";
            }
          });
        }
      };
  
      document.getElementById('typeFilter').addEventListener('change', App.filterJobs);
      document.getElementById('regionFilter').addEventListener('change', App.filterJobs);
  
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('part-filter')) {
          if (e.target.value === "ì „ì²´") {
            const allChecks = document.querySelectorAll('.part-filter');
            allChecks.forEach(chk => { chk.checked = e.target.checked; });
          }
          App.filterByParts();
        }
      });
  
      window.App = App;
    })();
  </script>
</body>
</html>
