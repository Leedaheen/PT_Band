<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-4">
<div class="flex justify-between items-center mb-4 border-b pb-2">
  <h1 class="text-3xl font-bold text-black">ğŸ“Œ í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§ ê²Œì‹œíŒ</h1>
  <button onclick="openForm()" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 text-sm rounded">+</button>
</div>

<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 text-sm p-3 rounded mb-6">
  <strong>â€» ê³µì§€ì‚¬í•­:</strong> ì´ ê²Œì‹œíŒì€ í‰íƒì§€ì—­ ë°´ë“œ ì»¤ë®¤ë‹ˆí‹°ìš©ì…ë‹ˆë‹¤. ë§¤ë„ˆë¥¼ ì§€ì¼œì£¼ì„¸ìš”!<br>
  <span class="block mt-1">ëª¨ë“  ë‹‰ë„¤ì„ì€ ì˜¤í”ˆí†¡ ìƒ ë‹‰ë„¤ì„ê³¼ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš” <strong>ì˜ˆ)</strong> í™ê¸¸ë™/ë³´ì»¬/30 â†’ <strong>í™ê¸¸ë™</strong></span>
</div>

<div class="mb-4 flex gap-2 flex-wrap">
  <button onclick="filterJobs('ì „ì²´')" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">ì „ì²´</button>
  <button onclick="filterJobs('êµ¬ì¸')" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">êµ¬ì¸ë§Œ ë³´ê¸°</button>
  <button onclick="filterJobs('êµ¬ì§')" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">êµ¬ì§ë§Œ ë³´ê¸°</button>
</div>

{% for job in jobs %}
<div class="bg-white p-4 mb-6 rounded shadow-lg relative job-item" data-type="{{ job.type }}">
  <div class="absolute top-2 right-3 flex gap-1">
    <button class="text-xs text-gray-600 hover:underline" onclick="openMatchPopup({{ loop.index0 }})">ë§¤ì¹­ìƒíƒœ ë³€ê²½</button>
  </div>
  <h2 class="text-xl font-semibold mb-1">[{{ job.team or 'íŒ€ëª… ë¯¸ì •' }}] <span class="text-sm text-gray-500 ml-1">({{ job.type }})</span></h2>
  <p class="text-sm text-gray-600 mb-2"><strong>{{ job.part|join(' / ') }}</strong>{% if job.type == 'êµ¬ì¸' %} ë©¤ë²„ í•„ìš”í•´ìš”!{% else %} íŒŒíŠ¸ ì§€ì›í•´ìš” {% endif %}
</p>

  <div class="expand-content hidden">
    <p class="text-sm text-gray-600"><strong>ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„:</strong> {{ job.nickname or '-' }}</p>
    <p class="text-sm text-gray-600"><strong>ìœ„ì¹˜:</strong> {{ job.location or '-' }}</p>
    <p class="text-sm text-gray-600"><strong>ì—°ë ¹ëŒ€:</strong> {{ job.age or '-' }}</p>
    {% if job.fee %}<p class="text-sm text-gray-600"><strong>ì›” íšŒë¹„:</strong> {{ job.fee }}</p>{% endif %}
        <p class="text-sm text-navy-700 font-bold">{{ job.intro or '' }}</p>
  </div>

  <div class="flex justify-between items-center mt-2">
    <span class="text-xs text-blue-500 cursor-pointer ml-1" onclick="toggleExpand(this)">&lt;ë” ë³´ê¸°&gt;</span>
    <a href="tel:{{ job.contact }}" onclick="fetch('/click/{{ loop.index0 }}', { method: 'POST' })" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ë§¤ì¹­í•˜ê¸° ({{ job.clicks or 0 }})</a>
  </div>
</div>
{% endfor %}

<script>
function filterJobs(type) {
  const items = document.querySelectorAll('.job-item');
  items.forEach(el => {
    el.style.display = (type === 'ì „ì²´' || el.dataset.type === type) ? 'block' : 'none';
  });
}

function openForm() {
  const popup = document.createElement('div');
  popup.className = 'fixed top-1/2 left-1/2 bg-white p-4 rounded shadow z-50 max-w-sm w-full';
  popup.style.transform = 'translate(-50%, -50%)';
  popup.innerHTML = `
    <div class='text-right'><button onclick='this.parentElement.parentElement.remove()' class='text-sm text-red-500'>âœ– ë‹«ê¸°</button></div>
    <form id='new-post-form'>
      <p class='mb-2 text-sm font-semibold'>ê¸€ ì‘ì„±í•˜ê¸°</p>
      <div class='mb-2'>
        <label class='block text-sm font-medium mb-1'>êµ¬ë¶„:</label>
        <select name='type' class='border p-1 w-full'>
          <option value='êµ¬ì¸'>êµ¬ì¸</option>
          <option value='êµ¬ì§'>êµ¬ì§</option>
        </select>
      </div>
      <div id='form-content'></div>
      <div class='mt-4 text-right'>
        <button type='submit' class='bg-blue-600 text-white px-3 py-1 rounded'>ë“±ë¡</button>
      </div>
    </form>`;
  document.body.appendChild(popup);

  const formTypeSelect = popup.querySelector('select[name="type"]');
  const formContent = popup.querySelector('#form-content');
  formTypeSelect.onchange = () => renderFormFields(formContent, formTypeSelect.value);
  renderFormFields(formContent, 'êµ¬ì¸');

  document.getElementById('new-post-form').onsubmit = (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const type = form.get('type');
    const payload = {
      type,
      team: form.get('team') || '',
      nickname: form.get('nickname') || '',
      location: form.get('location') || '',
      fee: form.get('fee') || '',
      contact: form.get('contact') || '',
      intro: form.get('intro') || '',
      password: form.get('password'),
      part: [...form.getAll('part')]
    };
    fetch('/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(res => res.json()).then(result => {
      if (result.success) location.reload();
      else alert('ë“±ë¡ ì‹¤íŒ¨: ' + (result.message || 'ì˜¤ë¥˜'));
    });
  }
}

function renderFormFields(container, type) {
  const partChecklist = ['ë³´ì»¬(ë‚¨)', 'ë³´ì»¬(ì—¬)', 'ë“œëŸ¼', 'ê¸°íƒ€', 'ë² ì´ìŠ¤', 'ê±´ë°˜', 'ê¸°íƒ€ íŒŒíŠ¸']
    .map(part => `<label class='mr-2'><input type='checkbox' name='part' value='${part}' class='mr-1' />${part}</label>`).join(' ');
  if (type === 'êµ¬ì¸') {
    container.innerHTML = `
      <input required name='team' placeholder='ë°´ë“œëª… í•„ìˆ˜' class='border p-1 w-full mb-2' />
      <input required name='nickname' placeholder='ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„ í•„ìˆ˜' class='border p-1 w-full mb-2' />
      <input name='age' placeholder='ë©¤ë²„ ì—°ë ¹ëŒ€' class='border p-1 w-full mb-2' />
      <div class='mb-2'><label class='block mb-1'>êµ¬ì¸ íŒŒíŠ¸:</label>${partChecklist}</div>
      <input required name='location' placeholder='ì—°ìŠµì‹¤ ìœ„ì¹˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
      <input name='fee' placeholder='ì›” íšŒë¹„ ì„ íƒ' class='border p-1 w-full mb-2' />
      <input required name='contact' placeholder='ì—°ë½ì²˜ í•„ìˆ˜' class='border p-1 w-full mb-2' />
      <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2' oninput="updateCharCount(this)"></textarea>
<div class='text-right text-xs text-gray-500' id='char-count'>(0/100 byte)</div>
      <input required name='password' type='password' placeholder='ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬' class='border p-1 w-full mb-2' />
    `;
  } else {
    container.innerHTML = `
      <input required name='nickname' placeholder='ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
      <div class='mb-2'><label class='block mb-1'>êµ¬ì§ íŒŒíŠ¸:</label>${partChecklist}</div>
      <input required name='location' placeholder='ì„ í˜¸ ì—°ìŠµì‹¤ ìœ„ì¹˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
      <input name='age' placeholder='ë©¤ë²„ ì—°ë ¹ëŒ€' class='border p-1 w-full mb-2' />
      <input required name='contact' placeholder='ì—°ë½ì²˜ (í•„ìˆ˜)' class='border p-1 w-full mb-2' />
      <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2'></textarea>
      <input required name='password' type='password' placeholder='ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)' class='border p-1 w-full mb-2' />
    `;
  }
}

    });
}

function openMatchPopup(index) {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê´€ë¦¬ì: admin1234)");
  if (!pw) return;
  fetch(`/verify-password/${index}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pw })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    const job = data.job;
    const parts = job.part || [];
    const partOptions = parts.map(part => `<label><input type='checkbox' name='match' value='${part}' ${job.matched_parts[part] ? 'checked' : ''}> ${part}</label>`).join('<br>');
    const html = `<div class='text-right mb-2'><button onclick='this.parentElement.parentElement.remove()' class='text-sm text-red-500'>âœ– ë‹«ê¸°</button></div><form id='match-form'>
      <p class='mb-2 text-sm font-semibold'>ê¸€ ìˆ˜ì • ë° ë§¤ì¹­ì™„ë£Œ ì„¤ì •</p>
      <input type='text' name='team' value='${job.team}' placeholder='íŒ€ëª…' class='border p-1 w-full mb-2' />
      <input type='text' name='location' value='${job.location}' placeholder='ìœ„ì¹˜' class='border p-1 w-full mb-2' />
      <input type='text' name='type' value='${job.type}' placeholder='êµ¬ë¶„ êµ¬ì¸/êµ¬ì§' class='border p-1 w-full mb-2' />
      <textarea name='intro' placeholder='ì„ í˜¸ ì¥ë¥´ ë° ê°„ë‹¨í•œ ì†Œê°œ (100ì ì´ë‚´)' maxlength='100' class='border p-1 w-full mb-2' oninput='updateCharCount(this)'>\${job.intro}</textarea><div class='text-right text-xs text-gray-500' id='char-count'>(\${new Blob([job.intro || '']).size}/100 byte)</div>
      <p class='mb-1 text-sm'>âœ… ë§¤ì¹­ ì™„ë£Œí•  íŒŒíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
      ${partOptions}
      <div class='mt-3'>
        <button type='submit' class='bg-green-600 text-white px-3 py-1 rounded'>ì €ì¥</button>
      </div>
    </form>`;
    const popup = document.createElement('div');
    popup.className = 'fixed top-1/2 left-1/2 bg-white p-4 rounded shadow z-50 max-w-sm w-full';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.innerHTML = html;
    document.body.appendChild(popup);

    document.getElementById('match-form').onsubmit = (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const updated = {
        team: form.get('team'),
        location: form.get('location'),
        type: form.get('type'),
        intro: form.get('intro'),
        password: pw,
        parts: [...e.target.querySelectorAll('input[name="match"]:checked')].map(i => i.value)
      };
      fetch(`/update/${index}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      }).then(res => res.json()).then(resp => {
        if (resp.success) location.reload();
        else alert("ì €ì¥ ì‹¤íŒ¨: " + (resp.message || "ì˜¤ë¥˜"));
      });
    }
  });
}
function toggleExpand(el) {
  const container = el.closest('.job-item');
  const content = container.querySelector('.expand-content');
  const toggleBtn = el;

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    toggleBtn.innerHTML = '&lt;ì ‘ê¸°&gt;'; toggleBtn.classList.add('text-left');
  } else {
    content.classList.add('hidden');
    toggleBtn.innerHTML = '&lt;ë” ë³´ê¸°&gt;'; toggleBtn.classList.add('text-left');
  }
}
}
function updateCharCount(textarea) {
  const countDisplay = document.getElementById('char-count');
  if (!countDisplay) return;
  const length = new Blob([textarea.value]).size;
  countDisplay.textContent = `(${length}/100 byte)`;
}
</script>


{% set has_matched = false %}
{% for job in jobs %}
  {% if job.matched_parts and job.matched_parts|length > 0 %}
    {% set has_matched = true %}
  {% endif %}
{% endfor %}
{% if has_matched %}
<div class="mt-10">
  <h2 class="text-lg font-bold text-gray-600 mb-3">âœ… ë§¤ì¹­ ì™„ë£Œëœ í•­ëª©</h2>
  {% for job in jobs %}
    {% if job.matched_parts and job.matched_parts|length > 0 %}
      <div class="bg-gray-200 text-gray-600 p-2 rounded mb-2">
        <span class="font-semibold">{{ job.team or 'íŒ€ëª… ë¯¸ì •' }}</span>
        - {{ job.matched_parts.keys()|join(', ') }}
      </div>
    {% endif %}
  {% endfor %}
</div>
{% endif %}
</body>
</html>
