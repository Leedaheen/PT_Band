<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link rel="icon" href="/static/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
        rel="stylesheet"/>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>
  <script>
    const SUPABASE_URL  = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON = 'YOUR_ANON_KEY';
  </script>
</head>
<body class="bg-gray-100 p-4">
  <!-- (ìƒëµ: í—¤ë” / ê³µì§€ / í•„í„° UI ë™ì¼) -->

  <div id="job-list" class="space-y-6"></div>

  <!-- â˜… ì—¬ê¸°ë§Œ type="module" ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”! -->
  <script type="module">
    const App = {
      supabase: null,
      selectedType: 'ì „ì²´',

      init() {
        this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        this.loadJobs();
        this.initRealtime();
      },

      initRealtime() {
        this.supabase
          .channel('public:jobs')
          .on('postgres_changes',
              { event: '*', schema: 'public', table: 'jobs' },
              () => this.applyFilters()
          )
          .subscribe();
      },

      async loadJobs() {
        const { data: jobs, error } = await this.supabase
          .from('jobs').select('*').order('created_at', { ascending: false });
        if (error) return console.error(error);

        // ì§€ì—­ ì˜µì…˜ ì±„ìš°ê¸°
        const regions = Array.from(new Set(jobs.map(j=>j.region||'ê²½ê¸°ë„ > í‰íƒì‹œ')));
        const regionSel = document.getElementById('regionFilter');
        regionSel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>'
          + regions.map(r=>`<option value="${r}">${r}</option>`).join('');
        regionSel.onchange = () => this.applyFilters();

        this.renderJobs(jobs);
        this.applyFilters();
      },

      renderJobs(jobs) {
        const container = document.getElementById('job-list');
        container.innerHTML = '';
        jobs.forEach(job => {
          const el = document.createElement('div');
          el.className = 'bg-white p-4 rounded shadow relative job-item';
          el.dataset.id      = job.id;
          el.dataset.type    = job.type;
          el.dataset.matched = job.is_matched;
          el.dataset.pinned  = job.pinned;
          el.dataset.region  = job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ';
          el.dataset.parts   = (job.part||[]).join(',');

          const emojiMap = {
            'ë³´ì»¬(ë‚¨)':'ğŸ¤','ë³´ì»¬(ì—¬)':'ğŸ¤','ë“œëŸ¼':'ğŸ¥',
            'ë² ì´ìŠ¤':'ğŸ¸','ê¸°íƒ€':'ğŸ¸','í‚¤ë³´ë“œ':'ğŸ¹','ê·¸ ì™¸':'ğŸ”¸'
          };
          const partsHtml = (job.part||[]).map(p=>`${emojiMap[p]||''}${p}`).join(' / ');
          const pinHtml = job.pinned
            ? `<span class="absolute top-1 left-1 text-yellow-500">ğŸ“Œ</span>`
            : '';

          el.innerHTML = `
            <div class="relative">
              ${pinHtml}
              <h2 class="text-lg font-semibold mb-1">
                ${job.type==='êµ¬ì§' ? `[ ${partsHtml} ]` : `[${job.team||'íŒ€ëª… ë¯¸ì •'}]`}
                <span class="text-sm text-gray-500 ml-1">
                  (${job.region||'ê²½ê¸°ë„ > í‰íƒì‹œ'} / ${job.type==='êµ¬ì§'?'ë°ë ¤ê°€ì„¸ìš”!':'ëª¨ì§‘í•©ë‹ˆë‹¤!'})
                </span>
              </h2>
              <p class="text-sm text-gray-600 mb-2">
                ${job.type==='êµ¬ì¸'
                  ? `<strong>${partsHtml}</strong> ë©¤ë²„ê°€ í•„ìš”í•´ìš”!`
                  : job.intro||''}
              </p>
              <div class="expand-content hidden text-sm text-gray-600 mb-2">
                <p><strong>ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„:</strong> ${job.nickname||'-'}</p>
                <p><strong>ìœ„ì¹˜:</strong> ${job.location||'-'}</p>
                <p><strong>ë‚˜ì´:</strong> ${job.age||'-'}</p>
                ${job.fee?`<p><strong>ì›” íšŒë¹„:</strong> ${job.fee}</p>`:''}
                <p><strong>ì†Œê°œ:</strong> ${job.intro||'-'}</p>
              </div>
              <div class="flex justify-between items-end">
                <span class="text-xs text-blue-500 cursor-pointer"
                      onclick="App.toggleExpand(this)">&lt;ë” ë³´ê¸°&gt;</span>
                <div class="text-right">
                  <p class="text-xs text-gray-400 mb-1">
                    ğŸ•’ ${new Date(job.updated_at||job.created_at).toLocaleString()}
                  </p>
                  <button onclick="App.incrementClick(${job.id})"
                          class="text-xs bg-blue-500 text-white px-1.5 py-[9px] rounded">
                    ì—°ë½ì²˜ í™•ì¸
                  </button>
                  <p class="text-xs text-gray-400 mt-1">
                    ğŸ‘ <span class="click-count">${job.clicks||0}</span>ëª…ì´ í™•ì¸
                  </p>
                </div>
              </div>
              <div class="absolute top-2 right-3">
                <button class="text-xs text-gray-600 hover:underline"
                        onclick="App.openMatchPopup(${job.id})">
                  ë§¤ì¹­ìƒíƒœ ë³€ê²½
                </button>
              </div>
            </div>`;
          container.appendChild(el);
        });
      },

      applyFilters() {
        const type   = this.selectedType;
        const region = document.getElementById('regionFilter').value;
        const parts  = [...document.querySelectorAll('.part-filter:checked')].map(c=>c.value);

        document.querySelectorAll('.job-item').forEach(el => {
          let show = true;
          if (type==='ë§¤ì¹­ì™„ë£Œ') show = el.dataset.matched==='true';
          else if (type!=='ì „ì²´') show = el.dataset.type===type;
          if (show && region!=='ì „ì²´') show = el.dataset.region===region;
          if (show && parts.length) {
            const itemParts = el.dataset.parts.split(',');
            show = parts.some(p=> itemParts.includes(p));
          }
          el.style.display = show ? '' : 'none';
        });
      },

      filterJobs(t) {
        this.selectedType = t;
        this.applyFilters();
      },

      filterParts() {
        this.applyFilters();
      },

      toggleExpand(el) {
        const content = el.closest('.job-item').querySelector('.expand-content');
        content.classList.toggle('hidden');
        el.textContent = content.classList.contains('hidden') ? '<ë” ë³´ê¸°>' : '<ì ‘ê¸°>';
      },

      async incrementClick(id) {
        const el    = document.querySelector(`.job-item[data-id="${id}"]`);
        const cntEl = el.querySelector('.click-count');
        let cnt = parseInt(cntEl.textContent, 10);
        const { error } = await this.supabase
          .from('jobs').update({ clicks: cnt+1 }).eq('id', id);
        if (error) return console.error(error);
        cntEl.textContent = cnt+1;
      },

      openForm() {
        import('/static/js/form-popup.js')
          .then(m=>m.default(this.supabase))
          .catch(console.error);
      },

      openMatchPopup(id) {
        import('/static/js/match-popup.js')
          .then(m=>m.default(id, this.supabase))
          .catch(console.error);
      }
    };

    window.addEventListener('DOMContentLoaded', ()=>App.init());
  </script>
</body>
</html>
