<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link rel="icon" href="/static/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <script>
    // ì‹¤ì œ ë°°í¬ ì‹œì—” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì„¸ìš”
    const SUPABASE_URL  = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtamVscXZwY3NhZm90dGJsdnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzNDcsImV4cCI6MjA1OTc2NjM0N30.Z8NfPAVbUz7BIi9ifS9bdVFXUYj6dgu00pwP6THNA8A';  // ì‹¤ì œ anon key
  </script>
</head>
<body class="bg-gray-100 p-4">
  <!-- í—¤ë” -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">ğŸš€í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§</h1>
    <button id="open-form-btn"
            class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 text-sm rounded">
      +ê¸€ ë“±ë¡
    </button>
  </div>

  <!-- ê³µì§€ì‚¬í•­ -->
  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 text-sm p-3 rounded mb-4">
    <strong>ì´ ê²Œì‹œíŒì€ í‰íƒì§€ì—­ ë°´ë“œ ì»¤ë®¤ë‹ˆí‹°ìš©ì…ë‹ˆë‹¤. ë§¤ë„ˆë¥¼ ì§€ì¼œì£¼ì„¸ìš”!</strong><br>
    <span class="block mt-1">
      ëª¨ë“  ë‹‰ë„¤ì„ì€ ì˜¤í”ˆí†¡ ìƒ ë‹‰ë„¤ì„ê³¼ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”<br>
      <strong>ì˜ˆ)</strong> í™ê¸¸ë™/ë³´ì»¬/30 â†’ <strong>í™ê¸¸ë™</strong>
    </span>
  </div>

  <!-- í•„í„°: íƒ€ì… + ì§€ì—­ + íŒŒíŠ¸ -->
  <div class="flex flex-wrap mb-4">
    <!-- íƒ€ì… í•„í„° -->
    <div class="flex space-x-1 mb-4 w-full sm:w-auto">
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm w-full sm:w-auto" data-filter="ì „ì²´">ì „ì²´</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm w-full sm:w-auto" data-filter="êµ¬ì¸">êµ¬ì¸</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm w-full sm:w-auto" data-filter="êµ¬ì§">êµ¬ì§</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm w-full sm:w-auto" data-filter="ë§¤ì¹­ì™„ë£Œ">ë§¤ì¹­ì™„ë£Œ</button>
    </div>

    <!-- ì§€ì—­ í•„í„° -->
    <div class="flex justify-end w-full sm:w-auto space-x-4">
      <select id="regionFilter" class="border p-1 text-sm w-full sm:w-auto h-10">
        <option value="ì „ì²´">ì „ì²´</option>
      </select>
    </div>
  </div>

  <!-- íŒŒíŠ¸ë³„ í•„í„° -->
  <div class="flex mb-4">
    <div class="flex space-x-1 w-full sm:w-auto">
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ë³´ì»¬(ë‚¨)">ë³´ì»¬(ë‚¨)</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ë³´ì»¬(ì—¬)">ë³´ì»¬(ì—¬)</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ë“œëŸ¼">ë“œëŸ¼</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ë² ì´ìŠ¤">ë² ì´ìŠ¤</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ê¸°íƒ€">ê¸°íƒ€</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="í‚¤ë³´ë“œ">í‚¤ë³´ë“œ</button>
      <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm w-full sm:w-auto" data-part="ê·¸ ì™¸">ê·¸ ì™¸</button>
    </div>
  </div>

  <!-- ë¦¬ìŠ¤íŠ¸ + í˜ì´ì§• -->
  <div id="job-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-4"></div>
  <div id="pagination" class="mt-4 flex justify-center items-center space-x-2"></div>

  <!-- ESM ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const App = {
      supabase,
      jobs: [],
      filteredJobs: [],
      pageSize: 10,
      currentPage: 1,
      selectedType: 'ì „ì²´',
      selectedParts: new Set(), // ì„ íƒëœ íŒŒíŠ¸ í•„í„°ë§

      init() {
        console.log("âœ… App.init: Supabase ì¤€ë¹„ë¨", this.supabase);
        this.loadJobs();
        this.initRealtime();

        // ê¸€ ë“±ë¡ ë²„íŠ¼
        document.getElementById('open-form-btn')
          .addEventListener('click', () => this.openForm());

        // í•„í„° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        document.querySelectorAll('.filter-btn')
          .forEach(btn => btn.addEventListener('click', () => {
            this.selectedType = btn.getAttribute('data-filter');
            this.applyFilters();
            this.updateActiveFilter(btn);
          }));

        // ì§€ì—­ í•„í„°
        document.getElementById('regionFilter')
          .addEventListener('change', () => this.applyFilters());

        // íŒŒíŠ¸ë³„ í•„í„°ë§ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        document.querySelectorAll('.part-filter-btn')
          .forEach(btn => btn.addEventListener('click', (e) => {
            const part = e.target.getAttribute('data-part');
            if (this.selectedParts.has(part)) {
              this.selectedParts.delete(part);
              e.target.classList.remove('bg-blue-500', 'text-white');
              e.target.classList.add('bg-blue-100', 'text-black');
            } else {
              this.selectedParts.add(part);
              e.target.classList.remove('bg-blue-100', 'text-black');
              e.target.classList.add('bg-blue-500', 'text-white');
            }
            this.applyFilters();
          }));
      },

      initRealtime() {
        this.supabase
          .channel('public:jobs')
          .on('postgres_changes',
              { event: '*', schema: 'public', table: 'jobs' },
              () => this.loadJobs()
          )
          .subscribe();
      },

      async loadJobs() {
        const { data, error } = await this.supabase
          .from('jobs').select('*').order('created_at', { ascending: false });
        if (error) return console.error("âŒ loadJobs ì˜¤ë¥˜:", error);
        this.jobs = data;

        // ì§€ì—­ í•„í„° ì˜µì…˜ ê°±ì‹ 
        const regions = Array.from(new Set(this.jobs.map(j => j.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ')));
        const regionSel = document.getElementById('regionFilter');
        regionSel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>' +
          regions.map(r => `<option value="${r}">${r}</option>`).join('');

        this.applyFilters();
      },

      applyFilters() {
        const region = document.getElementById('regionFilter').value;

        this.filteredJobs = this.jobs.filter(job => {
          let ok = true;
          if (this.selectedType === 'ë§¤ì¹­ì™„ë£Œ') ok = job.is_matched;
          else if (this.selectedType !== 'ì „ì²´') ok = job.type === this.selectedType;
          if (ok && region !== 'ì „ì²´') ok = (job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ') === region;

          if (ok && this.selectedParts.size > 0) {
            let arr = [];
            if (Array.isArray(job.part)) arr = job.part;
            else if (typeof job.part === 'string') {
              try { arr = JSON.parse(job.part); }
              catch { arr = job.part.split(','); }
            }
            ok = [...this.selectedParts].some(p => arr.includes(p));
          }
          return ok;
        });

        this.currentPage = 1;
        this.renderPage();
        this.renderPagination();
      },

      renderPage() {
        const start = (this.currentPage - 1) * this.pageSize;
        this.renderJobs(this.filteredJobs.slice(start, start + this.pageSize));
      },

renderJobs(jobs) {
  const container = document.getElementById('job-list');
  container.innerHTML = '';

  jobs.forEach(job => {
    const partsArray = Array.isArray(job.part) ? job.part : job.part.split(',');
    const emojiMap = {'ë³´ì»¬(ë‚¨)':'ğŸ¤','ë³´ì»¬(ì—¬)':'ğŸ¤','ë“œëŸ¼':'ğŸ¥','ë² ì´ìŠ¤':'ğŸ¸','ê¸°íƒ€':'ğŸ¸','í‚¤ë³´ë“œ':'ğŸ¹','ê·¸ ì™¸':'ğŸ”¸'};
    const partsHtml = partsArray.map(p => `${emojiMap[p] || ''}${p}`).join(' / ');

    const pinHtml = job.pinned ? `<span class="absolute top-1 left-1 text-yellow-500">ğŸ“Œ</span>` : '';

    // ë§¤ì¹­ì™„ë£Œ ìƒíƒœì¼ ë•Œë§Œ ë³´ì—¬ì£¼ëŠ” ë©”ì‹œì§€
    const isMatchedMessage = job.is_matched
      ? (job.type === 'êµ¬ì¸' ? `${job.team} - ${partsHtml} ëª¨ì§‘ ì™„ë£Œ!` : `${job.nickname} - ${partsHtml} ë°´ë“œ í•©ë¥˜ ì™„ë£Œ!`)
      : '';

    const el = document.createElement('div');
    el.className = 'bg-white p-4 rounded shadow relative job-item';
    el.dataset.id = job.id;
    el.dataset.type = job.type;
    el.dataset.matched = job.is_matched;
    el.dataset.pinned = job.pinned;
    el.dataset.region = job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ';

    // ë§¤ì¹­ì™„ë£Œëœ ê¸€ì˜ ê²½ìš° ì •ë³´ ìˆ¨ê¹€ ì²˜ë¦¬
    const jobContent = job.is_matched
      ? `
          <h2 class="text-lg font-semibold mb-1">
            ${job.type === 'êµ¬ì§' ? `[ ${partsHtml} ]` : `[${job.team || 'íŒ€ëª… ë¯¸ì •'}]`}
            <span class="text-sm text-gray-500 ml-1">(${job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ'} / ${job.type === 'êµ¬ì§' ? 'ë°ë ¤ê°€ì„¸ìš”!' : 'ëª¨ì§‘í•©ë‹ˆë‹¤!'})</span>
          </h2>
          <p class="text-sm text-gray-600 mb-2">
            ${isMatchedMessage}
          </p>
        `
      : `
          <h2 class="text-lg font-semibold mb-1">
            ${job.type === 'êµ¬ì§' ? `[ ${partsHtml} ]` : `[${job.team || 'íŒ€ëª… ë¯¸ì •'}]`}
            <span class="text-sm text-gray-500 ml-1">(${job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ'} / ${job.type === 'êµ¬ì§' ? 'ë°ë ¤ê°€ì„¸ìš”!' : 'ëª¨ì§‘í•©ë‹ˆë‹¤!'})</span>
          </h2>
          <p class="text-sm text-gray-600 mb-2">
            ${job.type === 'êµ¬ì¸' ? `<strong>${partsHtml}</strong> ë©¤ë²„ê°€ í•„ìš”í•´ìš”!` : job.intro || ''}
          </p>
          <div class="expand-content hidden text-sm text-gray-600 mb-2">
            <p><strong>ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„:</strong> ${job.nickname || '-'}</p>
            <p><strong>ìœ„ì¹˜:</strong> ${job.location || '-'}</p>
            <p><strong>ë‚˜ì´:</strong> ${job.age || '-'}</p>
            ${job.fee ? `<p><strong>ì›” íšŒë¹„:</strong> ${job.fee}</p>` : ''}
            <p><strong>ì†Œê°œ:</strong> ${job.intro || '-'}</p>
          </div>
        `;

    el.innerHTML = `
      <div class="relative">
        ${pinHtml}
        ${jobContent}
        <div class="flex justify-between items-end">
          <span class="text-xs text-blue-500 cursor-pointer" onclick="App.toggleExpand(this)">&lt;ë” ë³´ê¸°&gt;</span>
        </div>
      </div>
    `;

    container.appendChild(el);
  });
}


      renderPagination() {
        const total = Math.ceil(this.filteredJobs.length / this.pageSize);
        const pager = document.getElementById('pagination');
        pager.innerHTML = '';
        for (let i = 1; i <= total; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = `px-3 py-1 border rounded ${i === this.currentPage ? 'bg-blue-600 text-white' : 'bg-white'}`;
          btn.addEventListener('click', () => {
            this.currentPage = i;
            this.renderPage();
          });
          pager.appendChild(btn);
        }
      },

      updateActiveFilter(btn) {
        document.querySelectorAll('.filter-btn').forEach(button => {
          button.classList.remove('active');
        });
        btn.classList.add('active');
      }
    };

    window.App = App;
    App.init();
  </script>

  <!-- ì˜¤í”ˆí†¡ ë°”ë¡œê°€ê¸° ë²„íŠ¼ -->
  <a href="https://open.kakao.com/o/gnz12iXg" target="_blank"
     class="fixed bottom-4 right-4 flex items-center bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-2 rounded shadow-lg">
    <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png"
         alt="Kakao Open Chat" class="w-6 h-6 mr-2"/>
    <span class="text-sm font-medium">ì˜¤í”ˆí†¡ ë°”ë¡œê°€ê¸°</span>
  </a>

</body>
</html>
