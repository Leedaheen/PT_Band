<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" href="/static/favicon.ico" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>구인/구직 게시판</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- 1) Supabase JS 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>

  <!-- 2) 키 설정 (배포 시엔 안전하게 관리) -->
  <script>
    const SUPABASE_URL   = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtamVscXZwY3NhZm90dGJsdnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzNDcsImV4cCI6MjA1OTc2NjM0N30.Z8NfPAVbUz7BIi9ifS9bdVFXUYj6dgu00pwP6THNA8A';
  </script>
</head>
<body class="bg-gray-100 p-4">

  <!-- (기존 헤더/필터 UI는 그대로 두되, data-* 속성 제거) -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">🚀평택 직장인/취미 밴드 구인구직</h1>
    <button onclick="App.openForm()" class="text-white bg-blue-600 px-3 py-1 rounded">+글 등록</button>
  </div>
  <!-- 필터 영역… (생략) -->

  <!-- 3) 데이터를 렌더링할 컨테이너 -->
  <div id="job-list" class="space-y-6"></div>

<script>
  const App = {
    supabase: null,

    // 1) 초기화
    init() {
      this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      this.loadJobs();
      this.initRealtime();
    },

    // 2) 실시간 구독 설정
    initRealtime() {
      this.supabase
        .channel('public:jobs')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'jobs' },
          () => this.loadJobs()
        )
        .subscribe();
    },

    // 3) 전체 게시글 불러오기
    async loadJobs() {
      const { data: jobs, error } = await this.supabase
        .from('jobs')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) return console.error(error);
      this.renderJobs(jobs);
    },

    // 4) 화면에 렌더링
    renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';
      jobs.forEach(job => {
        // ... (기존 renderJobs 내부 HTML 생성 로직 그대로)
      });
    },

    // 5) 더 보기/접기
    toggleExpand(el) {
      const content = el.closest('.job-item').querySelector('.expand-content');
      content.classList.toggle('hidden');
      el.innerHTML = content.classList.contains('hidden') ? '<더 보기>' : '<접기>';
    },

    // 6) 클릭 수 증가
    async incrementClick(id) {
      // 6-1) 현재 clicks 조회
      const { data: job, error: fetchErr } = await this.supabase
        .from('jobs')
        .select('clicks')
        .eq('id', id)
        .single();
      if (fetchErr) return console.error(fetchErr);

      // 6-2) clicks + 1 업데이트
      const { error: updateErr } = await this.supabase
        .from('jobs')
        .update({ clicks: job.clicks + 1 })
        .eq('id', id);
      if (updateErr) console.error(updateErr);
    },

    // 7) 글 작성 팝업
    openForm() {
      import('/static/js/form-popup.js')
        .then(m => m.default(this.supabase))
        .catch(console.error);
    },

    // 8) 매칭 상태 팝업
    openMatchPopup(id) {
      import('/static/js/match-popup.js')
        .then(m => m.default(id, this.supabase))
        .catch(console.error);
    }
  };

  // 페이지 로드 시 초기화
  window.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>
