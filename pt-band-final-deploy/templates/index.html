<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link rel="icon" href="/static/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 p-4">
  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">ğŸš€í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§ (BETA)</h1>
    <button id="open-form-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 text-sm rounded">+ê¸€ ë“±ë¡</button>
  </div>

  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 text-sm p-3 rounded mb-4">
    <strong>ì´ ê²Œì‹œíŒì€ í‰íƒì§€ì—­ ë°´ë“œ ì»¤ë®¤ë‹ˆí‹°ìš©ì…ë‹ˆë‹¤. ë§¤ë„ˆë¥¼ ì§€ì¼œì£¼ì„¸ìš”!</strong>
    <p class="mt-1">ëª¨ë“  ë‹‰ë„¤ì„ì€ ì˜¤í”ˆí†¡ ìƒ ë‹‰ë„¤ì„ê³¼ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™/ë³´ì»¬/30 â†’ <strong>í™ê¸¸ë™</strong>)</p>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="flex justify-between items-center mb-4">
    <div class="flex space-x-2">
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="ì „ì²´">ì „ì²´</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="êµ¬ì¸">êµ¬ì¸</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="êµ¬ì§">êµ¬ì§</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="ë§¤ì¹­ì™„ë£Œ">ë§¤ì¹­ì™„ë£Œ</button>
    </div>
    <select id="regionFilter" class="border p-1 text-sm h-10 max-w-xs">
      <option value="ì „ì²´">ì „ì²´</option>
    </select>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŒŒíŠ¸ë³„ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="flex mb-4 space-x-1 w-full sm:w-auto">
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ë³´ì»¬(ë‚¨)">ë³´ì»¬(ë‚¨)</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ë³´ì»¬(ì—¬)">ë³´ì»¬(ì—¬)</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ë“œëŸ¼">ë“œëŸ¼</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ë² ì´ìŠ¤">ë² ì´ìŠ¤</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ê¸°íƒ€">ê¸°íƒ€</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="í‚¤ë³´ë“œ">í‚¤ë³´ë“œ</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="ê·¸ ì™¸">ê·¸ ì™¸</button>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ëª©ë¡ & í˜ì´ì§€ë„¤ì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="job-list" class="space-y-6 mb-4"></div>
  <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import openForm from '/static/js/form-popup.js';
    import openMatchPopup from '/static/js/match-popup.js';

    // íŒŒíŠ¸ë³„ ì´ëª¨ì§€ ë§¤í•‘
    const emojiMap = {
      'ë³´ì»¬(ë‚¨)': 'ğŸ¤ ',
      'ë³´ì»¬(ì—¬)': 'ğŸ¤ ',
      'ë“œëŸ¼': 'ğŸ¥ ',
      'ë² ì´ìŠ¤': 'ğŸ¸ ',
      'ê¸°íƒ€': 'ğŸ¸ ',
      'í‚¤ë³´ë“œ': 'ğŸ¹ ',
      'ê·¸ ì™¸': 'ğŸ¶ '
    };

    const SUPABASE_URL  = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtamVscXZwY3NhZm90dGJsdnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzNDcsImV4cCI6MjA1OTc2NjM0N30.Z8NfPAVbUz7BIi9ifS9bdVFXUYj6dgu00pwP6THNA8A';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const App = {
      supabase,
      jobs: [],
      filteredJobs: [],
      pageSize: 10,
      currentPage: 1,
      selectedType: 'ì „ì²´',
      selectedParts: new Set(),

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      init() {
        this.loadJobs();
        this.initRealtime();

        // ê¸€ ë“±ë¡ íŒì—…
        document.getElementById('open-form-btn').addEventListener('click', () => openForm(this.supabase));

        // ìƒë‹¨ íƒ€ì… í•„í„°
        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => {
          this.selectedType = btn.dataset.filter;
          this.applyFilters();
          this.updateActiveFilter(btn);
        }));

        // ì§€ì—­ í•„í„°
        document.getElementById('regionFilter').addEventListener('change', () => this.applyFilters());

        // íŒŒíŠ¸ í•„í„°
        document.querySelectorAll('.part-filter-btn').forEach(btn => btn.addEventListener('click', () => {
          const part = btn.dataset.part;
          if (this.selectedParts.has(part)) {
            this.selectedParts.delete(part);
            btn.classList.replace('bg-blue-500', 'bg-blue-100');
            btn.classList.replace('text-white',  'text-black');
          } else {
            this.selectedParts.add(part);
            btn.classList.replace('bg-blue-100', 'bg-blue-500');
            btn.classList.replace('text-black',  'text-white');
          }
          this.applyFilters();
        }));

        // ëª©ë¡ ë‚´ë¶€ ì´ë²¤íŠ¸ (í† ê¸€Â·ë§¤ì¹­ìƒíƒœ ë³€ê²½)
        document.getElementById('job-list').addEventListener('click', e => {
          const matchBtn = e.target.closest('.match-btn');
          if (matchBtn) {
            openMatchPopup(Number(matchBtn.dataset.id));
            return;
          }
          const item   = e.target.closest('.job-item');
          if (!item) return;
          const content  = item.querySelector('.expand-content');
          const toggleEl = item.querySelector('.expand-toggle');
          if (content && toggleEl) {
            const hidden = content.classList.toggle('hidden');
            toggleEl.textContent = hidden ? 'â–¶ ë” ë³´ê¸°' : 'â–¼ ì ‘ê¸°';
          }
        });
      },

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì‹¤ì‹œê°„ êµ¬ë… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      initRealtime() {
        this.supabase
          .channel('public:jobs')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' }, () => this.loadJobs())
          .subscribe();
      },

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async loadJobs() {
        const { data, error } = await this.supabase
          .from('jobs')
          .select('*')
          .order('pinned',     { ascending: false })
          .order('created_at', { ascending: false });
        if (error) return console.error(error);
        this.jobs = data;
        this.refreshRegionOptions();
        this.applyFilters();
      },

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì§€ì—­ ì…€ë ‰íŠ¸ ì˜µì…˜ ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      refreshRegionOptions() {
        const sel = document.getElementById('regionFilter');
        sel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>' +
          Array.from(new Set(this.jobs.map(j => j.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ')))
            .map(r => `<option>${r}</option>`).join('');
      },

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í•„í„° ì ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      applyFilters() {
        const region = document.getElementById('regionFilter').value;
        this.filteredJobs = this.jobs.filter(job => {
          // â‘  ë§¤ì¹­ì™„ë£Œ íƒ­ì€ is_matched=true ë§Œ!
          if (this.selectedType === 'ë§¤ì¹­ì™„ë£Œ') {
            return job.is_matched;
          }

          // â‘¡ ë§¤ì¹­ë˜ì§€ ì•Šì€ ê¸€ë§Œ (ë§¤ì¹­ì™„ë£Œ íƒ­ ì œì™¸)
          if (job.is_matched) return false;

          // â‘¢ íƒ€ì… í•„í„°
          if (this.selectedType !== 'ì „ì²´' && job.type !== this.selectedType) return false;

          // â‘£ ì§€ì—­ í•„í„°
          if (region !== 'ì „ì²´' && (job.region || 'ê²½ê¸°ë„ > í‰
