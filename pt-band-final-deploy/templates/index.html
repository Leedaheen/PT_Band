<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" href="/static/favicon.ico" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- 1) Supabase JS ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>

  <!-- 2) í‚¤ ì„¤ì • (ë°°í¬ ì‹œì—” ì•ˆì „í•˜ê²Œ ê´€ë¦¬) -->
  <script>
    const SUPABASE_URL   = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtamVscXZwY3NhZm90dGJsdnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzNDcsImV4cCI6MjA1OTc2NjM0N30.Z8NfPAVbUz7BIi9ifS9bdVFXUYj6dgu00pwP6THNA8A';
  </script>
</head>
<body class="bg-gray-100 p-4">

  <!-- (ê¸°ì¡´ í—¤ë”/í•„í„° UIëŠ” ê·¸ëŒ€ë¡œ ë‘ë˜, data-* ì†ì„± ì œê±°) -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">ğŸš€í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§</h1>
    <button onclick="App.openForm()" class="text-white bg-blue-600 px-3 py-1 rounded">+ê¸€ ë“±ë¡</button>
  </div>
  <!-- í•„í„° ì˜ì—­â€¦ (ìƒëµ) -->

  <!-- 3) ë°ì´í„°ë¥¼ ë Œë”ë§í•  ì»¨í…Œì´ë„ˆ -->
  <div id="job-list" class="space-y-6"></div>

<script>
  const App = {
    supabase: null,

    // 1) ì´ˆê¸°í™”
    init() {
      this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      this.loadJobs();
      this.initRealtime();
    },

    // 2) ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
    initRealtime() {
      this.supabase
        .channel('public:jobs')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'jobs' },
          () => this.loadJobs()
        )
        .subscribe();
    },

    // 3) ì „ì²´ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async loadJobs() {
      const { data: jobs, error } = await this.supabase
        .from('jobs')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) return console.error(error);
      this.renderJobs(jobs);
    },

    // 4) í™”ë©´ì— ë Œë”ë§
    renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';
      jobs.forEach(job => {
        // ... (ê¸°ì¡´ renderJobs ë‚´ë¶€ HTML ìƒì„± ë¡œì§ ê·¸ëŒ€ë¡œ)
      });
    },

    // 5) ë” ë³´ê¸°/ì ‘ê¸°
    toggleExpand(el) {
      const content = el.closest('.job-item').querySelector('.expand-content');
      content.classList.toggle('hidden');
      el.innerHTML = content.classList.contains('hidden') ? '<ë” ë³´ê¸°>' : '<ì ‘ê¸°>';
    },

    // 6) í´ë¦­ ìˆ˜ ì¦ê°€
    async incrementClick(id) {
      // 6-1) í˜„ì¬ clicks ì¡°íšŒ
      const { data: job, error: fetchErr } = await this.supabase
        .from('jobs')
        .select('clicks')
        .eq('id', id)
        .single();
      if (fetchErr) return console.error(fetchErr);

      // 6-2) clicks + 1 ì—…ë°ì´íŠ¸
      const { error: updateErr } = await this.supabase
        .from('jobs')
        .update({ clicks: job.clicks + 1 })
        .eq('id', id);
      if (updateErr) console.error(updateErr);
    },

    // 7) ê¸€ ì‘ì„± íŒì—…
    openForm() {
      import('/static/js/form-popup.js')
        .then(m => m.default(this.supabase))
        .catch(console.error);
    },

    // 8) ë§¤ì¹­ ìƒíƒœ íŒì—…
    openMatchPopup(id) {
      import('/static/js/match-popup.js')
        .then(m => m.default(id, this.supabase))
        .catch(console.error);
    }
  };

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  window.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>
