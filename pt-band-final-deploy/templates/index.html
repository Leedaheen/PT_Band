<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- 1) Supabase JS ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>

  <!-- 2) í‚¤ ì„¤ì • (ë°°í¬ ì‹œì—” ì•ˆì „í•˜ê²Œ ê´€ë¦¬) -->
  <script>
    const SUPABASE_URL   = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON  = 'YOUR_ANON_PUBLIC_KEY';
  </script>
</head>
<body class="bg-gray-100 p-4">

  <!-- (ê¸°ì¡´ í—¤ë”/í•„í„° UIëŠ” ê·¸ëŒ€ë¡œ ë‘ë˜, data-* ì†ì„± ì œê±°) -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">ğŸš€í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§</h1>
    <button onclick="App.openForm()" class="text-white bg-blue-600 px-3 py-1 rounded">+ê¸€ ë“±ë¡</button>
  </div>
  <!-- í•„í„° ì˜ì—­â€¦ (ìƒëµ) -->

  <!-- 3) ë°ì´í„°ë¥¼ ë Œë”ë§í•  ì»¨í…Œì´ë„ˆ -->
  <div id="job-list" class="space-y-6"></div>

  <script>
  const App = {
    // 4) Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    supabase: null,
    init() {
      this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // 1) ì´ˆê¸° ë¡œë“œ
      this.loadJobs();

      // 2) í•œ ë²ˆë§Œ êµ¬ë… ì„¤ì •
      this.supabase
        .channel('public:jobs')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'jobs' },
            payload => this.loadJobs()
        )
        .subscribe();
    },
    // ... loadJobs, toggleExpand, openForm, openMatchPopup ë“±
  };

  window.addEventListener('DOMContentLoaded', () => App.init());

    // ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ
    

    // 5) ì „ì²´ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì™€ì„œ ë Œë”ë§
    async loadJobs() {
      const { data: jobs, error } = await this.supabase
        .from('jobs')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) return console.error(error);
      this.renderJobs(jobs);
    },

    // 6) ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë… (INSERT/UPDATE/DELETE)
    initRealtime() {
      this.supabase
        .channel('public:jobs')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' },
          payload => this.loadJobs()
        )
        .subscribe();
    },

    // 7) DOMì— job í•­ëª© ë Œë”ë§
    renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';  // ì´ˆê¸°í™”

      jobs.forEach(job => {
        const el = document.createElement('div');
        el.className = `bg-white p-4 rounded shadow job-item`;
        el.dataset.id = job.id;
        el.dataset.type = job.type;
        el.dataset.matched = job.is_matched;
        el.dataset.pinned = job.pinned;

        // í•€ í‘œì‹œ
        const pinHtml = job.pinned
          ? `<span class="absolute top-1 left-1 text-yellow-500">ğŸ“Œ</span>`
          : '';

        // íŒŒíŠ¸ë³„ ì´ëª¨ì§€ ë§µ (í•„ìš”ì‹œ í™•ì¥)
        const emojiMap = {
          'ë³´ì»¬(ë‚¨)': 'ğŸ¤','ë³´ì»¬(ì—¬)': 'ğŸ¤','ë“œëŸ¼': 'ğŸ¥',
          'ë² ì´ìŠ¤': 'ğŸ¸','ê¸°íƒ€': 'ğŸ¸','í‚¤ë³´ë“œ': 'ğŸ¹','ê·¸ ì™¸': 'ğŸ”¸'
        };
        const partsHtml = (job.part || [])
          .map(p => `${emojiMap[p]||''}${p}`).join(' / ');

        el.innerHTML = `
          <div class="relative">
            ${pinHtml}
            <h2 class="text-lg font-semibold mb-1">
              ${job.type==='êµ¬ì§'
                ? `[ ${partsHtml} ]`
                : `[${job.team||'íŒ€ëª… ë¯¸ì •'}]`
              }
              <span class="text-sm text-gray-500 ml-1">
                (${job.region||'ê²½ê¸°ë„ > í‰íƒì‹œ'} / ${job.type==='êµ¬ì§'?'ë°ë ¤ê°€ì„¸ìš”!':'ëª¨ì§‘í•©ë‹ˆë‹¤!'})
              </span>
            </h2>
            <p class="text-sm text-gray-600 mb-2">
              ${job.type==='êµ¬ì¸'
                ? `<strong>${partsHtml}</strong> ë©¤ë²„ê°€ í•„ìš”í•´ìš”!`
                : job.intro||''
              }
            </p>
            <div class="expand-content hidden text-sm text-gray-600">
              <p><strong>ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„:</strong> ${job.nickname||'-'}</p>
              <p><strong>ìœ„ì¹˜:</strong> ${job.location||'-'}</p>
              <p><strong>ë‚˜ì´:</strong> ${job.age||'-'}</p>
              ${job.fee?`<p><strong>ì›” íšŒë¹„:</strong> ${job.fee}</p>`:''}
              <p><strong>ì†Œê°œ:</strong> ${job.intro||'-'}</p>
            </div>
            <div class="flex justify-between items-end mt-2">
              <span class="text-xs text-blue-500 cursor-pointer" onclick="App.toggleExpand(this)">
                &lt;ë” ë³´ê¸°&gt;
              </span>
              <div class="text-right">
                <p class="text-xs text-gray-400 mb-1">
                  ğŸ•’ ${new Date(job.updated_at||job.created_at).toLocaleString()} ë“±ë¡
                </p>
                <button onclick="App.incrementClick(${job.id})"
                        class="text-xs bg-blue-500 text-white px-1.5 py-[9px] rounded">
                  ì—°ë½ì²˜ í™•ì¸
                </button>
                <p class="text-xs text-gray-400 mt-1">ğŸ‘ ${job.clicks||0}ëª…ì´ í™•ì¸</p>
              </div>
            </div>
          </div>`;
        container.appendChild(el);
      });
    },

    toggleExpand(el) {
      const content = el.closest('.job-item').querySelector('.expand-content');
      content.classList.toggle('hidden');
      el.innerHTML = content.classList.contains('hidden') ? '&lt;ë” ë³´ê¸°&gt;' : '&lt;ì ‘ê¸°&gt;';
    },

    // í´ë¦­ ìˆ˜ 1 ì¦ê°€
    async incrementClick(id) {
      // optimistic UI ì—…ë°ì´íŠ¸
      const btn = document.querySelector(`.job-item[data-id="${id}"] button`);
      btn.disabled = true;
      await this.supabase
        .from('jobs')
        .update({ clicks: supabase.raw('clicks + 1') })
        .eq('id', id);
      btn.disabled = false;
    },

    openForm() {
      import('/static/js/form-popup.js').then(m=>m.default(this.supabase));
    }
  };

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  window.addEventListener('DOMContentLoaded', ()=>App.init());
  </script>
</body>
</html>
