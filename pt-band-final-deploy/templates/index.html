<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>구인/구직 게시판</title>
  <link rel="icon" href="/static/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 p-4">
  <!-- 헤더 -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">🚀평택 직장인/취미 밴드 구인구직</h1>
    <button id="open-form-btn" class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 text-sm rounded">
      +글 등록
    </button>
  </div>

  <!-- 공지사항 -->
  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 text-sm p-3 rounded mb-4">
    <strong>이 게시판은 평택지역 밴드 커뮤니티용입니다. 매너를 지켜주세요!</strong><br>
    <span class="block mt-1">
      모든 닉네임은 오픈톡 상 닉네임과 일치시켜주세요<br>
      <strong>예)</strong> 홍길동/보컬/30 → <strong>홍길동</strong>
    </span>
  </div>

  <!-- 필터: 타입 + 지역 -->
  <div class="flex flex-wrap items-center mb-4 space-x-4">
    <!-- 타입 필터 -->
    <div class="flex space-x-1 w-full sm:w-auto">
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="전체">전체</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="구인">구인</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="구직">구직</button>
      <button class="filter-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm" data-filter="매칭완료">매칭완료</button>
    </div>
    <!-- 지역 필터 -->
    <div class="flex justify-end w-full sm:w-auto">
      <select id="regionFilter" class="border p-1 text-sm h-10">
        <option value="전체">전체</option>
      </select>
    </div>
  </div>

  <!-- 파트별 필터 -->
  <div class="flex mb-4">
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="보컬(남)">보컬(남)</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="보컬(여)">보컬(여)</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="드럼">드럼</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="베이스">베이스</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="기타">기타</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="키보드">키보드</button>
    <button class="part-filter-btn px-3 py-2 bg-blue-100 hover:bg-blue-300 rounded text-sm" data-part="그 외">그 외</button>
  </div>

  <!-- 리스트 + 페이징 -->
  <div id="job-list" class="space-y-6 mb-4"></div>
  <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>

  <!-- ESM 모듈 스크립트 -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import openForm from '/static/js/form-popup.js';
    import openMatchPopup from '/static/js/match-popup.js';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const App = {
      supabase,
      jobs: [],
      filteredJobs: [],
      pageSize: 10,
      currentPage: 1,
      selectedType: '전체',
      selectedParts: new Set(),

      init() {
        this.loadJobs();
        this.initRealtime();

        // 글 등록 팝업
        document.getElementById('open-form-btn')
          .addEventListener('click', () => openForm(this.supabase));

        // 타입 필터
        document.querySelectorAll('.filter-btn').forEach(btn =>
          btn.addEventListener('click', () => {
            this.selectedType = btn.dataset.filter;
            this.applyFilters();
            this.updateActiveFilter(btn);
          })
        );

        // 지역 필터
        document.getElementById('regionFilter')
          .addEventListener('change', () => this.applyFilters());

        // 파트 필터
        document.querySelectorAll('.part-filter-btn').forEach(btn =>
          btn.addEventListener('click', e => {
            const part = e.currentTarget.dataset.part;
            if (this.selectedParts.has(part)) {
              this.selectedParts.delete(part);
              btn.classList.replace('bg-blue-500','bg-blue-100');
              btn.classList.replace('text-white','text-black');
            } else {
              this.selectedParts.add(part);
              btn.classList.replace('bg-blue-100','bg-blue-500');
              btn.classList.replace('text-black','text-white');
            }
            this.applyFilters();
          })
        );

        // 매칭상태 변경 팝업 (이벤트 위임)
        document.getElementById('job-list').addEventListener('click', e => {
          if (e.target.matches('.match-btn')) {
            const id = Number(e.target.dataset.id);
            openMatchPopup(id);
          }
        });
      },

      initRealtime() {
        this.supabase
          .channel('public:jobs')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' }, () => this.loadJobs())
          .subscribe();
      },

      async loadJobs() {
        const { data, error } = await this.supabase
          .from('jobs').select('*').order('created_at', { ascending: false });
        if (error) return console.error(error);
        this.jobs = data;
        this.refreshRegionOptions();
        this.applyFilters();
      },

      refreshRegionOptions() {
        const regions = Array.from(new Set(this.jobs.map(j => j.region || '경기도 > 평택시')));
        const sel = document.getElementById('regionFilter');
        sel.innerHTML = '<option value="전체">전체</option>' +
          regions.map(r => `<option>${r}</option>`).join('');
      },

      applyFilters() {
        const region = document.getElementById('regionFilter').value;
        this.filteredJobs = this.jobs.filter(job => {
          let ok = (this.selectedType === '매칭완료') ? job.is_matched
                   : (this.selectedType === '전체') ? true
                   : job.type === this.selectedType;
          if (ok && region !== '전체') ok = (job.region||'경기도 > 평택시') === region;
          if (ok && this.selectedParts.size) {
            const parts = Array.isArray(job.part) ? job.part : job.part.split(',');
            ok = [...this.selectedParts].some(p=>parts.includes(p));
          }
          return ok;
        });
        this.currentPage = 1;
        this.renderPage();
        this.renderPagination();
      },

      renderPage() {
        const start = (this.currentPage - 1) * this.pageSize;
        this.renderJobs(this.filteredJobs.slice(start, start + this.pageSize));
      },

      renderJobs(jobs) {
        const container = document.getElementById('job-list');
        container.innerHTML = '';
        jobs.forEach(job => {
          const parts = Array.isArray(job.part) ? job.part : job.part.split(',');
          const partsHtml = parts.join(' / ');
          const pin = job.pinned ? '<span class="absolute top-1 left-1 text-yellow-500">📌</span>' : '';
          const matchedMsg = job.is_matched
            ? `<p class="text-sm">${job.type==='구인'
                ? `${job.team} - ${partsHtml} 모집 완료!`
                : `${job.nickname} - ${partsHtml} 밴드 합류 완료!`}</p>`
            : '';
          const expand = job.is_matched ? ''
            : `<span class="text-xs text-blue-500 cursor-pointer" onclick="App.toggleExpand(this)">&lt;더 보기&gt;</span>`;
          const matchBtn = job.is_matched ? ''
            : `<button class="match-btn text-xs text-gray-600 hover:underline absolute top-2 right-3" data-id="${job.id}">매칭상태 변경</button>`;

          container.insertAdjacentHTML('beforeend', `
            <div class="bg-white p-4 rounded shadow relative job-item">
              ${pin}
              <h2 class="text-lg font-semibold mb-1">
                ${job.type==='구직' ? `[${partsHtml}]` : `[${job.team||'팀명 미정'}]`}
                <span class="text-sm text-gray-500 ml-1">
                  (${job.region||'경기도 > 평택시'} / ${job.type==='구직'?'데려가세요!':'모집합니다!'})
                </span>
              </h2>
              ${ matchedMsg || `<p class="text-sm">${job.type==='구인'
                ? `<strong>${partsHtml}</strong> 멤버가 필요해요!`
                : job.intro||''}</p>` }
              <div class="expand-content hidden text-sm text-gray-600 mb-2">
                <p><strong>오픈톡 닉네임:</strong> ${job.nickname||'-'}</p>
                <p><strong>위치:</strong> ${job.location||'-'}</p>
                <p><strong>나이:</strong> ${job.age||'-'}</p>
                ${job.fee?`<p><strong>월 회비:</strong> ${job.fee}</p>`:''}
                <p><strong>소개:</strong> ${job.intro||'-'}</p>
              </div>
              <div class="text-right text-xs text-gray-400 mt-1">
                <p>🕒 ${new Date(job.updated_at||job.created_at).toLocaleString()}</p>
                <a href="tel:${job.contact}" onclick="App.incrementClick(${job.id})" class="inline-block bg-blue-500 text-white px-1.5 py-[2px] rounded">연락처 확인</a>
                <p>👁 ${job.clicks||0}명 확인</p>
              </div>
              ${expand}
              ${matchBtn}
            </div>
          `);
        });
      },

      renderPagination() {
        const total = Math.ceil(this.filteredJobs.length / this.pageSize);
        const pager = document.getElementById('pagination');
        pager.innerHTML = '';
        for (let i=1; i<=total; i++) {
          const cls = i===this.currentPage ? 'bg-blue-600 text-white' : 'bg-white';
          pager.insertAdjacentHTML('beforeend', `<button class="px-3 py-1 border rounded ${cls}">${i}</button>`);
        }
        pager.querySelectorAll('button').forEach((b, idx)=> {
          b.addEventListener('click', ()=> {
            this.currentPage = idx+1;
            this.renderPage();
          });
        });
      },

      updateActiveFilter(btn) {
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      },

      toggleExpand(el) {
        const cont = el.closest('.job-item').querySelector('.expand-content');
        cont.classList.toggle('hidden');
        el.textContent = cont.classList.contains('hidden') ? '<더 보기>' : '<접기>';
      },

      incrementClick(id) {
        this.supabase.from('jobs').update({ clicks: supabase.postgrest.raw('clicks+1') }).eq('id', id).then(()=> this.loadJobs());
      }
    };

    window.App = App;
    App.init();
  </script>
</body>
</html>
