<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>êµ¬ì¸/êµ¬ì§ ê²Œì‹œíŒ</title>
  <link rel="icon" href="/static/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>
  <script>
    // ë°°í¬ ì‹œì—” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì„¸ìš”
    const SUPABASE_URL  = 'https://dmjelqvpcsafottblvwx.supabase.co';
    const SUPABASE_ANON = 'YOUR_ANON_KEY';
  </script>
</head>
<body class="bg-gray-100 p-4">
  <!-- í—¤ë” -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">ğŸš€í‰íƒ ì§ì¥ì¸/ì·¨ë¯¸ ë°´ë“œ êµ¬ì¸êµ¬ì§</h1>
    <button onclick="App.openForm()"
            class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 text-sm rounded">
      +ê¸€ ë“±ë¡
    </button>
  </div>

  <!-- ê³µì§€ì‚¬í•­ -->
  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 text-sm p-3 rounded mb-4">
    <strong>ì´ ê²Œì‹œíŒì€ í‰íƒì§€ì—­ ë°´ë“œ ì»¤ë®¤ë‹ˆí‹°ìš©ì…ë‹ˆë‹¤. ë§¤ë„ˆë¥¼ ì§€ì¼œì£¼ì„¸ìš”!</strong><br>
    <span class="block mt-1">
      ëª¨ë“  ë‹‰ë„¤ì„ì€ ì˜¤í”ˆí†¡ ìƒ ë‹‰ë„¤ì„ê³¼ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”<br>
      <strong>ì˜ˆ)</strong> í™ê¸¸ë™/ë³´ì»¬/30 â†’ <strong>í™ê¸¸ë™</strong>
    </span>
  </div>

  <!-- í•„í„°: íƒ€ì… + ì§€ì—­ -->
  <div class="flex justify-between items-center mb-4">
    <div class="flex space-x-1">
      <button onclick="App.filterJobs('ì „ì²´')" class="filter-btn px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">ì „ì²´</button>
      <button onclick="App.filterJobs('êµ¬ì¸')" class="filter-btn px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">êµ¬ì¸</button>
      <button onclick="App.filterJobs('êµ¬ì§')" class="filter-btn px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">êµ¬ì§</button>
      <button onclick="App.filterJobs('ë§¤ì¹­ì™„ë£Œ')" class="filter-btn px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">ë§¤ì¹­ì™„ë£Œ</button>
    </div>
    <select id="regionFilter" class="border p-1 text-sm">
      <option value="ì „ì²´">ì „ì²´</option>
    </select>
  </div>

  <!-- íŒŒíŠ¸ í•„í„° -->
  <div class="flex items-center mb-6">
    <label class="text-sm mr-2">íŒŒíŠ¸ :</label>
    <div class="flex flex-wrap gap-2">
      <label><input type="checkbox" class="part-filter" value="ë³´ì»¬(ë‚¨)" onclick="App.filterParts()"/>ë³´ì»¬(ë‚¨)</label>
      <label><input type="checkbox" class="part-filter" value="ë³´ì»¬(ì—¬)" onclick="App.filterParts()"/>ë³´ì»¬(ì—¬)</label>
      <label><input type="checkbox" class="part-filter" value="ë“œëŸ¼"    onclick="App.filterParts()"/>ë“œëŸ¼</label>
      <label><input type="checkbox" class="part-filter" value="ë² ì´ìŠ¤" onclick="App.filterParts()"/>ë² ì´ìŠ¤</label>
      <label><input type="checkbox" class="part-filter" value="ê¸°íƒ€"    onclick="App.filterParts()"/>ê¸°íƒ€</label>
      <label><input type="checkbox" class="part-filter" value="í‚¤ë³´ë“œ" onclick="App.filterParts()"/>í‚¤ë³´ë“œ</label>
      <label><input type="checkbox" class="part-filter" value="ê·¸ ì™¸"  onclick="App.filterParts()"/>ê·¸ ì™¸</label>
    </div>
  </div>

  <!-- ë¦¬ìŠ¤íŠ¸ + í˜ì´ì§• -->
  <div id="job-list" class="space-y-6"></div>
  <div id="pagination" class="mt-4 flex justify-center items-center space-x-2"></div>

  
<!--###################################################################################################################################-->

  
  <!-- module íƒ€ì…ìœ¼ë¡œ í•´ì•¼ import() ë™ì‘ -->
 <script type="module">
  // 1) ESM ë°©ì‹ìœ¼ë¡œ Supabase ë¶ˆëŸ¬ì˜¤ê¸°
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // 2) í™˜ê²½ë³€ìˆ˜ë¡œ ì •ì˜í•œ URL/KEYë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON);

  const App = {
    supabase: supabaseClient,   // supabaseClient í• ë‹¹
    jobs: [],
    filteredJobs: [],
    pageSize: 10,
    currentPage: 1,
    selectedType: 'ì „ì²´',

    init() {
      console.log("âœ… App.init: Supabase ready", this.supabase);
      this.loadJobs();
      this.initRealtime();

      // ë²„íŠ¼ & í•„í„° ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.getElementById('open-form-btn')
              .addEventListener('click', () => this.openForm());
      document.querySelectorAll('.filter-btn')
              .forEach(btn => btn.addEventListener('click', () => {
                this.selectedType = btn.textContent;
                this.applyFilters();
              }));
      document.getElementById('regionFilter')
              .addEventListener('change', () => this.applyFilters());
      document.querySelectorAll('.part-filter')
              .forEach(chk => chk.addEventListener('change', () => this.applyFilters()));
    },

    initRealtime() {
      this.supabase
        .channel('public:jobs')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'jobs' },
            () => this.loadJobs()
        )
        .subscribe();
    },

    async loadJobs() {
      const { data, error } = await this.supabase
        .from('jobs').select('*').order('created_at', { ascending: false });
      if (error) return console.error("âŒ loadJobs:", error);
      this.jobs = data;

      // ì§€ì—­ í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
      const regions = Array.from(new Set(this.jobs.map(j=>j.region||'ê²½ê¸°ë„ > í‰íƒì‹œ')));
      const regionSel = document.getElementById('regionFilter');
      regionSel.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>' +
        regions.map(r=>`<option value="${r}">${r}</option>`).join('');

      this.applyFilters();
    },

    applyFilters() {
      const region = document.getElementById('regionFilter').value;
      const parts  = [...document.querySelectorAll('.part-filter:checked')].map(c=>c.value);

      this.filteredJobs = this.jobs.filter(job => {
        let ok = true;
        if (this.selectedType==='ë§¤ì¹­ì™„ë£Œ') ok = job.is_matched;
        else if (this.selectedType!=='ì „ì²´') ok = job.type===this.selectedType;
        if (ok && region!=='ì „ì²´') ok = (job.region||'ê²½ê¸°ë„ > í‰íƒì‹œ')===region;
        if (ok && parts.length) ok = parts.some(p=> (job.part||[]).includes(p));
        return ok;
      });

      this.currentPage = 1;
      this.renderPage();
      this.renderPagination();
    },

    renderPage() {
      const start = (this.currentPage-1)*this.pageSize;
      this.renderJobs(this.filteredJobs.slice(start, start+this.pageSize));
    },

    renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';
      jobs.forEach(job => {
        const el = document.createElement('div');
        el.className = 'bg-white p-4 rounded shadow relative job-item';
        el.dataset.id      = job.id;
        el.dataset.type    = job.type;
        el.dataset.matched = job.is_matched;
        el.dataset.pinned  = job.pinned;
        el.dataset.region  = job.region || 'ê²½ê¸°ë„ > í‰íƒì‹œ';
        el.dataset.parts   = (job.part||[]).join(',');

        const emojiMap = {'ë³´ì»¬(ë‚¨)':'ğŸ¤','ë³´ì»¬(ì—¬)':'ğŸ¤','ë“œëŸ¼':'ğŸ¥','ë² ì´ìŠ¤':'ğŸ¸','ê¸°íƒ€':'ğŸ¸','í‚¤ë³´ë“œ':'ğŸ¹','ê·¸ ì™¸':'ğŸ”¸'};
        const partsHtml = (job.part||[]).map(p=>`${emojiMap[p]||''}${p}`).join(' / ');
        const pinHtml = job.pinned
          ? `<span class="absolute top-1 left-1 text-yellow-500">ğŸ“Œ</span>`
          : '';

        el.innerHTML = `
          <div class="relative">
            ${pinHtml}
            <h2 class="text-lg font-semibold mb-1">
              ${job.type==='êµ¬ì§' ? `[ ${partsHtml} ]` : `[${job.team||'íŒ€ëª… ë¯¸ì •'}]`}
              <span class="text-sm text-gray-500 ml-1">
                (${job.region||'ê²½ê¸°ë„ > í‰íƒì‹œ'} / ${job.type==='êµ¬ì§'?'ë°ë ¤ê°€ì„¸ìš”!':'ëª¨ì§‘í•©ë‹ˆë‹¤!'})
              </span>
            </h2>
            <p class="text-sm text-gray-600 mb-2">
              ${job.type==='êµ¬ì¸' ? `<strong>${partsHtml}</strong> ë©¤ë²„ê°€ í•„ìš”í•´ìš”!` : job.intro||''}
            </p>
            <div class="expand-content hidden text-sm text-gray-600 mb-2">
              <p><strong>ì˜¤í”ˆí†¡ ë‹‰ë„¤ì„:</strong> ${job.nickname||'-'}</p>
              <p><strong>ìœ„ì¹˜:</strong> ${job.location||'-'}</p>
              <p><strong>ë‚˜ì´:</strong> ${job.age||'-'}</p>
              ${job.fee?`<p><strong>ì›” íšŒë¹„:</strong> ${job.fee}</p>`:''}
              <p><strong>ì†Œê°œ:</strong> ${job.intro||'-'}</p>
            </div>
            <div class="flex justify-between items-end">
              <span class="text-xs text-blue-500 cursor-pointer" onclick="App.toggleExpand(this)">&lt;ë” ë³´ê¸°&gt;</span>
              <div class="text-right">
                <p class="text-xs text-gray-400 mb-1">ğŸ•’ ${new Date(job.updated_at||job.created_at).toLocaleString()}</p>
                <button onclick="App.incrementClick(${job.id})" class="text-xs bg-blue-500 text-white px-1.5 py-[9px] rounded">ì—°ë½ì²˜ í™•ì¸</button>
                <p class="text-xs text-gray-400 mt-1">ğŸ‘ <span class="click-count">${job.clicks||0}</span>ëª…ì´ í™•ì¸</p>
              </div>
            </div>
            <div class="absolute top-2 right-3">
              <button class="text-xs text-gray-600 hover:underline" onclick="App.openMatchPopup(${job.id})">ë§¤ì¹­ìƒíƒœ ë³€ê²½</button>
            </div>
          </div>`;
        container.appendChild(el);
      });
    },

    renderPagination() {
      const total = Math.ceil(this.filteredJobs.length / this.pageSize);
      const pager = document.getElementById('pagination');
      pager.innerHTML = '';
      for (let i=1; i<=total; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 border rounded ${i===this.currentPage?'bg-blue-600 text-white':'bg-white'}`;
        btn.addEventListener('click', () => {
          this.currentPage = i;
          this.renderPage();
        });
        pager.appendChild(btn);
      }
    },

    toggleExpand(el) {
      const content = el.closest('.job-item').querySelector('.expand-content');
      content.classList.toggle('hidden');
      el.textContent = content.classList.contains('hidden') ? '<ë” ë³´ê¸°>' : '<ì ‘ê¸°>';
    },

    async incrementClick(id) {
      const job = this.jobs.find(j=>j.id===id);
      const newCount = (job.clicks||0) + 1;
      const { error } = await this.supabase.from('jobs').update({ clicks: newCount }).eq('id', id);
      if (error) return console.error("âŒ incrementClick:", error);
      job.clicks = newCount;
      this.renderPage();
    },

    openForm() {
      console.log("â–¶ï¸ openForm: supabaseClient =", this.supabase);
      import('/static/js/form-popup.js')
        .then(m => m.default(this.supabase))
        .catch(err => console.error("âŒ openForm import:", err));
    },

    openMatchPopup(id) {
      import('/static/js/match-popup.js')
        .then(m => m.default(id, this.supabase))
        .catch(err => console.error("âŒ openMatchPopup import:", err));
    }
  };

  // ì „ì—­ ë…¸ì¶œ
  window.App = App;
  // ì¦‰ì‹œ ì´ˆê¸°í™”
  App.init();
</script>



  
  <!-- ì˜¤í”ˆí†¡ ë°”ë¡œê°€ê¸° ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) -->
  <a href="https://open.kakao.com/o/gnz12iXg"
     target="_blank"
     class="fixed bottom-4 right-4 flex items-center bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-2 rounded shadow-lg">
    <!-- ì¹´ì¹´ì˜¤ ì•„ì´ì½˜ (ê³µì‹ ë¡œê³ ) -->
    <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png"
         alt="Kakao Open Chat"
         class="w-6 h-6 mr-2"/>
    <span class="text-sm font-medium">ì˜¤í”ˆí†¡ ë°”ë¡œê°€ê¸°</span>
  </a>

</body>
</html>
