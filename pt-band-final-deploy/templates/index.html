<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>구인/구직 게시판</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- 1) Supabase JS 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>

  <!-- 2) 키 설정 (배포 시엔 안전하게 관리) -->
  <script>
    const SUPABASE_URL   = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON  = 'YOUR_ANON_PUBLIC_KEY';
  </script>
</head>
<body class="bg-gray-100 p-4">

  <!-- (기존 헤더/필터 UI는 그대로 두되, data-* 속성 제거) -->
  <div class="flex justify-between items-center mb-2">
    <h1 class="text-xl font-bold">🚀평택 직장인/취미 밴드 구인구직</h1>
    <button onclick="App.openForm()" class="text-white bg-blue-600 px-3 py-1 rounded">+글 등록</button>
  </div>
  <!-- 필터 영역… (생략) -->

  <!-- 3) 데이터를 렌더링할 컨테이너 -->
  <div id="job-list" class="space-y-6"></div>

  <script>
  const App = {
    // 4) Supabase 클라이언트 초기화
    supabase: null,
    init() {
      this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // 1) 초기 로드
      this.loadJobs();

      // 2) 한 번만 구독 설정
      this.supabase
        .channel('public:jobs')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'jobs' },
            payload => this.loadJobs()
        )
        .subscribe();
    },
    // ... loadJobs, toggleExpand, openForm, openMatchPopup 등
  };

  window.addEventListener('DOMContentLoaded', () => App.init());

    // 실시간 데이터 로드
    

    // 5) 전체 게시글 불러와서 렌더링
    async loadJobs() {
      const { data: jobs, error } = await this.supabase
        .from('jobs')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) return console.error(error);
      this.renderJobs(jobs);
    },

    // 6) 실시간 업데이트 구독 (INSERT/UPDATE/DELETE)
    initRealtime() {
      this.supabase
        .channel('public:jobs')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' },
          payload => this.loadJobs()
        )
        .subscribe();
    },

    // 7) DOM에 job 항목 렌더링
    renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';  // 초기화

      jobs.forEach(job => {
        const el = document.createElement('div');
        el.className = `bg-white p-4 rounded shadow job-item`;
        el.dataset.id = job.id;
        el.dataset.type = job.type;
        el.dataset.matched = job.is_matched;
        el.dataset.pinned = job.pinned;

        // 핀 표시
        const pinHtml = job.pinned
          ? `<span class="absolute top-1 left-1 text-yellow-500">📌</span>`
          : '';

        // 파트별 이모지 맵 (필요시 확장)
        const emojiMap = {
          '보컬(남)': '🎤','보컬(여)': '🎤','드럼': '🥁',
          '베이스': '🎸','기타': '🎸','키보드': '🎹','그 외': '🔸'
        };
        const partsHtml = (job.part || [])
          .map(p => `${emojiMap[p]||''}${p}`).join(' / ');

        el.innerHTML = `
          <div class="relative">
            ${pinHtml}
            <h2 class="text-lg font-semibold mb-1">
              ${job.type==='구직'
                ? `[ ${partsHtml} ]`
                : `[${job.team||'팀명 미정'}]`
              }
              <span class="text-sm text-gray-500 ml-1">
                (${job.region||'경기도 > 평택시'} / ${job.type==='구직'?'데려가세요!':'모집합니다!'})
              </span>
            </h2>
            <p class="text-sm text-gray-600 mb-2">
              ${job.type==='구인'
                ? `<strong>${partsHtml}</strong> 멤버가 필요해요!`
                : job.intro||''
              }
            </p>
            <div class="expand-content hidden text-sm text-gray-600">
              <p><strong>오픈톡 닉네임:</strong> ${job.nickname||'-'}</p>
              <p><strong>위치:</strong> ${job.location||'-'}</p>
              <p><strong>나이:</strong> ${job.age||'-'}</p>
              ${job.fee?`<p><strong>월 회비:</strong> ${job.fee}</p>`:''}
              <p><strong>소개:</strong> ${job.intro||'-'}</p>
            </div>
            <div class="flex justify-between items-end mt-2">
              <span class="text-xs text-blue-500 cursor-pointer" onclick="App.toggleExpand(this)">
                &lt;더 보기&gt;
              </span>
              <div class="text-right">
                <p class="text-xs text-gray-400 mb-1">
                  🕒 ${new Date(job.updated_at||job.created_at).toLocaleString()} 등록
                </p>
                <button onclick="App.incrementClick(${job.id})"
                        class="text-xs bg-blue-500 text-white px-1.5 py-[9px] rounded">
                  연락처 확인
                </button>
                <p class="text-xs text-gray-400 mt-1">👁 ${job.clicks||0}명이 확인</p>
              </div>
            </div>
          </div>`;
        container.appendChild(el);
      });
    },

    toggleExpand(el) {
      const content = el.closest('.job-item').querySelector('.expand-content');
      content.classList.toggle('hidden');
      el.innerHTML = content.classList.contains('hidden') ? '&lt;더 보기&gt;' : '&lt;접기&gt;';
    },

    // 클릭 수 1 증가
    async incrementClick(id) {
      // optimistic UI 업데이트
      const btn = document.querySelector(`.job-item[data-id="${id}"] button`);
      btn.disabled = true;
      await this.supabase
        .from('jobs')
        .update({ clicks: supabase.raw('clicks + 1') })
        .eq('id', id);
      btn.disabled = false;
    },

    openForm() {
      import('/static/js/form-popup.js').then(m=>m.default(this.supabase));
    }
  };

  // 페이지 로드 시 초기화
  window.addEventListener('DOMContentLoaded', ()=>App.init());
  </script>
</body>
</html>
